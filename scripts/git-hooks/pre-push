#!/bin/bash
# Pre-push hook to run CI checks locally before pushing
# Mirrors .github/workflows/ci.yml to catch issues early
#
# Skip with: git push --no-verify

set -e

echo "ğŸ” Running pre-push checks (matches CI workflow)..."
echo ""

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "âŒ Not in project root directory"
    exit 1
fi

# 1. Linting
echo "ğŸ“ Running ruff..."
if ! uv run ruff check conduit/ --quiet; then
    echo "âŒ Ruff linting failed"
    echo "   Fix with: uv run ruff check conduit/ --fix"
    exit 1
fi
echo "âœ… Ruff passed"

# 2. Formatting
echo ""
echo "ğŸ¨ Checking black formatting..."
if ! uv run black conduit/ --check --quiet; then
    echo "âŒ Black formatting failed"
    echo "   Fix with: uv run black conduit/"
    exit 1
fi
echo "âœ… Black passed"

# 3. Type checking (non-blocking, matches CI)
echo ""
echo "ğŸ”¤ Running mypy..."
if ! uv run mypy conduit/ --no-error-summary > /dev/null 2>&1; then
    echo "âš ï¸  Mypy has errors (non-blocking)"
else
    echo "âœ… Mypy passed"
fi

# 4. Tests (quick - only unit tests to keep it fast)
echo ""
echo "ğŸ§ª Running unit tests..."
if ! uv run pytest tests/unit/ -q --tb=no; then
    echo "âŒ Tests failed"
    exit 1
fi
echo "âœ… Tests passed"

echo ""
echo "âœ… All pre-push checks passed!"
echo "   Pushing to remote..."
