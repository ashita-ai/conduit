#!/bin/bash
# Pre-push hook to run CI checks locally before pushing
# Mirrors .github/workflows/ci.yml to catch issues early
#
# Skip with: git push --no-verify

set -e

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo "âŒ Not in project root directory"
    exit 1
fi

# Detect if changes are documentation-only
# Compare against the remote branch we're pushing to
REMOTE_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "origin/main")
CHANGED_FILES=$(git diff --name-only "$REMOTE_BRANCH"...HEAD 2>/dev/null || git diff --name-only --cached)

# Documentation patterns (docs/, *.md files, specific doc files)
DOC_PATTERN="^(docs/|.*\.md$|README|CONTRIBUTING|LICENSE|CHANGELOG|AUTHORS)"

# Check if ALL changes are docs-only
if echo "$CHANGED_FILES" | grep -qvE "$DOC_PATTERN"; then
    DOCS_ONLY=false
else
    DOCS_ONLY=true
fi

if [ "$DOCS_ONLY" = true ]; then
    echo "ğŸ“ Documentation-only changes detected"
    echo "   Skipping tests and type checking for faster push"
    echo ""

    # Still run basic linting on docs
    echo "ğŸ“ Running ruff..."
    if ! uv run ruff check conduit/ --quiet; then
        echo "âŒ Ruff linting failed"
        echo "   Fix with: uv run ruff check conduit/ --fix"
        exit 1
    fi
    echo "âœ… Ruff passed"

    echo ""
    echo "âœ… Documentation checks passed!"
    echo "   Pushing to remote..."
    exit 0
fi

# Full checks for code changes
echo "ğŸ” Running pre-push checks (matches CI workflow)..."
echo ""

# 1. Linting
echo "ğŸ“ Running ruff..."
if ! uv run ruff check conduit/ --quiet; then
    echo "âŒ Ruff linting failed"
    echo "   Fix with: uv run ruff check conduit/ --fix"
    exit 1
fi
echo "âœ… Ruff passed"

# 2. Formatting
echo ""
echo "ğŸ¨ Checking black formatting..."
if ! uv run black conduit/ --check --quiet; then
    echo "âŒ Black formatting failed"
    echo "   Fix with: uv run black conduit/"
    exit 1
fi
echo "âœ… Black passed"

# 3. Type checking (non-blocking, matches CI)
echo ""
echo "ğŸ”¤ Running mypy..."
if ! uv run mypy conduit/ --no-error-summary > /dev/null 2>&1; then
    echo "âš ï¸  Mypy has errors (non-blocking)"
else
    echo "âœ… Mypy passed"
fi

# 4. Tests (quick - only fast unit tests, skip slow/downloads)
echo ""
echo "ğŸ§ª Running fast unit tests..."
if ! uv run pytest tests/unit/ -q --tb=no -m "not slow and not downloads_models and not requires_api_key"; then
    echo "âŒ Tests failed"
    exit 1
fi
echo "âœ… Tests passed"

echo ""
echo "âœ… All pre-push checks passed!"
echo "   Pushing to remote..."
