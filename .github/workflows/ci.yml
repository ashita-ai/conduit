name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

env:
  UV_CACHE_DIR: /tmp/.uv-cache
  PYTHON_VERSION: "3.13"

jobs:
  # Skip full CI for documentation-only changes
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'conduit/**'
              - 'tests/**'
              - 'examples/**'
              - 'pyproject.toml'
              - 'alembic/**'
              - '.github/workflows/**'

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv with cache
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ruff
        run: uv run ruff check conduit/

      - name: Check black formatting
        run: uv run black conduit/ --check

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv with cache
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run mypy
        run: uv run mypy conduit/ --no-error-summary

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv with cache
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run unit tests
        run: uv run pytest tests/unit/ -v --tb=short -m "not slow and not downloads_models and not requires_api_key"

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    timeout-minutes: 10
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: conduit_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up uv with cache
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/conduit_test
        run: uv run alembic upgrade head

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/conduit_test
        run: uv run pytest tests/integration/ tests/regression/ -v --tb=short -m "not slow and not downloads_models and not requires_api_key"

  test-coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-unit, test-integration]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: conduit_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up uv with cache
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/conduit_test
        run: uv run alembic upgrade head

      - name: Run full test suite with coverage
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/conduit_test
        run: uv run pytest --cov=conduit --cov-report=term-missing --cov-fail-under=80

  # Aggregates all job results for branch protection
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [changes, lint, type-check, test-unit, test-integration]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.changes.outputs.code }}" != "true" ]; then
            echo "Documentation-only change, skipping code checks"
            exit 0
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint failed"
            exit 1
          fi
          if [ "${{ needs.type-check.result }}" != "success" ]; then
            echo "Type check failed"
            exit 1
          fi
          if [ "${{ needs.test-unit.result }}" != "success" ]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.test-integration.result }}" != "success" ]; then
            echo "Integration tests failed"
            exit 1
          fi
          echo "All checks passed!"
