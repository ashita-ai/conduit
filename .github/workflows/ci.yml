name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  # Skip full CI for documentation-only changes
  check-docs-only:
    name: Check if docs-only
    runs-on: ubuntu-latest
    outputs:
      docs_only: ${{ steps.filter.outputs.docs_only }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs_only:
              - 'docs/**'
              - '**.md'
              - 'README'
              - 'CONTRIBUTING'
              - 'LICENSE'
              - 'CHANGELOG'
              - 'AUTHORS'

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: check-docs-only
    if: needs.check-docs-only.outputs.docs_only == 'false'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: conduit_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/conduit_test
        run: uv run alembic upgrade head

      - name: Run fast tests (PRs)
        if: github.event_name == 'pull_request'
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/conduit_test
        run: uv run pytest tests/ -v --tb=short -m "not slow and not downloads_models and not requires_api_key"

      - name: Run full test suite with coverage (main/releases)
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/conduit_test
        run: uv run pytest --cov=conduit --cov-report=term-missing --cov-fail-under=80

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    needs: check-docs-only
    if: needs.check-docs-only.outputs.docs_only == 'false'

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ruff
        run: uv run ruff check conduit/

      - name: Check black formatting
        run: uv run black conduit/ --check

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: check-docs-only
    if: needs.check-docs-only.outputs.docs_only == 'false'

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run mypy
        run: uv run mypy conduit/ --no-error-summary || true
        # Note: Currently allows type errors (|| true) until existing errors are fixed
        # Remove '|| true' once type checking is clean
